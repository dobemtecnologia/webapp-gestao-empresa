<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <div class="chat-header">
      <div class="avatar-container">
        <img src="assets/evah.png" alt="Eva" class="avatar-img">
        <div class="status-indicator"></div>
      </div>
      <div class="header-info">
        <h2>Eva</h2>
        <span class="status-text">Online agora</span>
      </div>
      <ion-buttons slot="end">
        <ion-button (click)="resetWizard()">
          <ion-icon name="refresh-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="chat-content" #content>
  <div class="chat-container">
    @for (msg of chatHistory(); track msg.timestamp) {
      <div class="message-wrapper" [class.user-message]="msg.sender === 'user'" [class.eva-message]="msg.sender === 'eva'">
        <div class="message-bubble">
          @if (msg.type === 'text') {
            <p [innerHTML]="msg.content"></p>
          }
          <span class="message-time">{{ msg.timestamp | date:'HH:mm' }}</span>
        </div>
      </div>
    }

    @if (isTyping) {
      <div class="message-wrapper eva-message typing-wrapper">
        <div class="message-bubble typing-bubble">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    }
    
    <div id="scroll-anchor"></div>
  </div>
</ion-content>

<ion-footer class="chat-input-area" [class.hidden]="isTyping">
  <div class="input-container">
    
    <!-- Passo 0: Nome -->
    @if (currentStep() === 0) {
      <div class="step-input name-input">
        <ion-item lines="none" class="custom-input name-input-item">
          <ion-input 
            placeholder="Digite seu nome..." 
            [(ngModel)]="tempName"
            (keyup.enter)="confirmName()"
            autofocus>
          </ion-input>
          <ion-button slot="end" fill="clear" (click)="confirmName()" [disabled]="!tempName" class="send-name-btn">
            <ion-icon name="send"></ion-icon>
          </ion-button>
        </ion-item>
      </div>
    }

    <!-- Passo 0.5: CNPJ -->
    @if (currentStep() === 0.5) {
      <div class="step-input cnpj-input">
        <ion-item lines="none" class="custom-input">
          <ion-icon name="business-outline" slot="start"></ion-icon>
          <ion-input 
            type="text"
            placeholder="00.000.000/0000-00" 
            [value]="tempCNPJ"
            (ionInput)="onCNPJInput($event)"
            (keyup.enter)="consultarCNPJ()"
            [disabled]="isConsultingCNPJ"
            maxlength="18"
            autofocus>
          </ion-input>
          <ion-button 
            slot="end" 
            fill="clear" 
            (click)="consultarCNPJ()" 
            [disabled]="!tempCNPJ || isConsultingCNPJ" 
            class="send-name-btn">
            @if (isConsultingCNPJ) {
              <ion-spinner name="crescent"></ion-spinner>
            } @else {
              <ion-icon name="search"></ion-icon>
            }
          </ion-button>
        </ion-item>
      </div>
    }

    <!-- Passo 1: Setores -->
    @if (currentStep() === 1) {
      <div class="step-input component-input">
        <div class="input-header">
          <span>Selecione os setores</span>
        </div>
        
        <div class="sectors-list-container">
          @if (carregandoSetores) {
            <div class="loading-container">
              <ion-spinner></ion-spinner>
            </div>
          } @else {
            <ion-list class="sectors-list">
              @for (setor of setoresDisponiveis; track setor.id) {
                <ion-item 
                  class="sector-item"
                  [class.selected]="isSetorSelected(setor)"
                  (click)="toggleSetor(setor)">
                  <ion-checkbox 
                    slot="start" 
                    [checked]="isSetorSelected(setor)"
                    (ionChange)="$event.stopPropagation()"
                    (click)="$event.stopPropagation()">
                  </ion-checkbox>
                  <div class="sector-icon-wrapper" slot="start">
                    <ion-icon 
                      [name]="setor.icone || 'business'" 
                      class="sector-icon">
                    </ion-icon>
                  </div>
                  <ion-label>
                    <h3>{{ setor.nome }}</h3>
                  </ion-label>
                </ion-item>
              }
            </ion-list>
          }
        </div>

        <ion-button expand="block" (click)="nextStep()" [disabled]="selectedSectors().length === 0" class="action-btn">
          Confirmar Setores
        </ion-button>
      </div>
    }

    <!-- Passo 2: Assistentes -->
    @if (currentStep() === 2) {
      <div class="step-input component-input">
        <div class="input-header">
          <span>Defina a quantidade</span>
        </div>
        <div class="scrollable-component">
          <app-wizard-step-assistants></app-wizard-step-assistants>
        </div>
        <ion-button expand="block" (click)="nextStep()" [disabled]="!canProceedToNextStep()" class="action-btn">
          Confirmar Assistentes
        </ion-button>
      </div>
    }

    <!-- Passo 3: Canais -->
    @if (currentStep() === 3) {
      <div class="step-input component-input">
        <div class="input-header">
          <span>Configure os canais</span>
        </div>
        <div class="scrollable-component">
          <app-wizard-step-channels></app-wizard-step-channels>
        </div>
        <ion-button expand="block" (click)="nextStep()" [disabled]="!canProceedToNextStep()" class="action-btn">
          Confirmar Canais
        </ion-button>
      </div>
    }

    <!-- Passo 4: Infraestrutura -->
    @if (currentStep() === 4) {
      <div class="step-input component-input">
         <div class="input-header">
          <span>Escolha a infraestrutura</span>
        </div>
        <div class="scrollable-component">
          <app-wizard-step-infrastructure></app-wizard-step-infrastructure>
        </div>
        <ion-button expand="block" (click)="nextStep()" [disabled]="!canProceedToNextStep()" class="action-btn">
          Confirmar Infraestrutura
        </ion-button>
      </div>
    }

    <!-- Passo 5: Volume -->
    @if (currentStep() === 5) {
      <div class="step-input component-input">
        <div class="input-header">
          <span>Volume Mensal</span>
        </div>
        <div class="scrollable-component">
          <app-wizard-step-volume></app-wizard-step-volume>
        </div>
        <ion-button expand="block" (click)="nextStep()" [disabled]="!canProceedToNextStep()" class="action-btn">
          Confirmar Volume
        </ion-button>
      </div>
    }

    <!-- Passo 6: Período -->
    @if (currentStep() === 6) {
      <div class="step-input component-input">
        <div class="input-header">
          <span>Período de Contratação</span>
        </div>
        <div class="scrollable-component">
          <app-wizard-step-period></app-wizard-step-period>
        </div>
         <ion-button expand="block" (click)="nextStep()" [disabled]="!canProceedToNextStep()" class="action-btn">
          Confirmar Período
        </ion-button>
      </div>
    }

    <!-- Passo 7: Resumo (Review) + confirmação do valor -->
    @if (currentStep() === 7) {
      <div class="step-input final-step">
        <div class="success-buttons">
          <ion-button 
            expand="block" 
            color="success" 
            (click)="onConcordarResumo()" 
            class="action-btn">
            <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
            Concordo com o valor do orçamento
          </ion-button>

          <ion-button 
            expand="block" 
            fill="outline" 
            color="warning" 
            (click)="onAlterarResumo()" 
            class="action-btn mt-2">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Quero alterar os valores
          </ion-button>
        </div>
      </div>
    }

    <!-- Passo 8: Captura de Lead (Email/Telefone) -->
    @if (currentStep() === 8) {
      <div class="step-input email-input">
        <div class="input-header">
          <span>Dados de Contato</span>
        </div>
        <div class="contact-form">
          <ion-item lines="none" class="custom-input mb-2">
            <ion-icon name="mail-outline" slot="start"></ion-icon>
            <ion-input 
              type="email" 
              placeholder="Seu melhor e-mail..." 
              [(ngModel)]="tempEmail"
              (keyup.enter)="finalizarOrcamento()">
            </ion-input>
          </ion-item>
          
          <ion-item lines="none" class="custom-input">
            <ion-icon name="call-outline" slot="start"></ion-icon>
            <ion-input 
              type="tel" 
              placeholder="WhatsApp (Opcional)..." 
              [(ngModel)]="tempPhone"
              (keyup.enter)="finalizarOrcamento()">
            </ion-input>
          </ion-item>

          <ion-button 
            expand="block" 
            color="success"
            (click)="finalizarOrcamento()" 
            [disabled]="isLoading || !isValidEmail(tempEmail)" 
            class="action-btn">
            @if (isLoading) {
              <ion-spinner name="crescent" color="light"></ion-spinner>
              <span class="ml-2">Gerando Proposta...</span>
            } @else {
              Gerar Proposta Oficial
              <ion-icon name="document-text-outline" slot="end"></ion-icon>
            }
          </ion-button>
        </div>
      </div>
    }

    <!-- Passo 9: Sucesso / Ações Finais -->
    @if (currentStep() === 9) {
      <div class="step-input success-actions">
        <div class="success-buttons">
          <ion-button 
            expand="block" 
           color="success"
            (click)="verPropostaCompleta()" 
            [disabled]="!orcamentoFinalizadoHash"
            class="action-btn">
            <ion-icon name="document-text-outline" slot="start"></ion-icon>
            Ver Proposta Completa
          </ion-button>
          
          <ion-button expand="block" fill="outline" color="warning" (click)="resetWizard()" class="action-btn mt-2">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Novo orçamento
          </ion-button>
        </div>
      </div>
    }

  </div>
</ion-footer>
