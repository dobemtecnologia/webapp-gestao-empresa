<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>Formul√°rio de Or√ßamento</ion-title>
      <ion-buttons slot="end">
        <ion-button routerLink="/wizard">
          <ion-icon name="chatbubbles-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <form [formGroup]="formulario" (ngSubmit)="finalizarOrcamento()">
    
    <!-- Stepper Indicator -->
    <div class="stepper-container">
      <div class="stepper-steps">
        <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
          <div class="step-number">1</div>
          <div class="step-label">Dados do Cliente</div>
        </div>
        <div class="step-line" [class.completed]="currentStep > 1"></div>
        <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
          <div class="step-number">2</div>
          <div class="step-label">Configura√ß√£o</div>
        </div>
        <div class="step-line" [class.completed]="currentStep > 2"></div>
        <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
          <div class="step-number">3</div>
          <div class="step-label">Revis√£o</div>
        </div>
        <div class="step-line" [class.completed]="currentStep > 3"></div>
        <div class="step" [class.active]="currentStep === 4" [class.completed]="currentStep === 4">
          <div class="step-number">4</div>
          <div class="step-label">Proposta</div>
        </div>
      </div>
    </div>

    <!-- Step 1: Dados do Cliente -->
    @if (currentStep === 1) {
      <div class="step-content">
        <app-dados-cliente 
          [formGroup]="formulario"
          (cnpjConsultado)="onSetoresChange($event)">
        </app-dados-cliente>
      </div>
    }

    <!-- Step 2: Configura√ß√£o do Plano -->
    @if (currentStep === 2) {
      <div class="step-content">
        <app-configuracao-plano
          [formGroup]="formulario"
          (setoresChange)="onSetoresChange($event)"
          (assistentesChange)="onAssistentesChange($event)"
          (canaisChange)="onCanaisChange($event.canais, $event.assistantChannels)"
          (infrastructureChange)="onInfrastructureChange($event)"
          (periodoChange)="onPeriodoChange($event)"
          (nextMainStep)="nextStep()">
        </app-configuracao-plano>
      </div>
    }

    <!-- Step 3: Revis√£o -->
    @if (currentStep === 3) {
      <div class="step-content">
        <app-resumo-orcamento
          [formulario]="formulario"
          [resultadoSimulacao]="resultadoSimulacao">
        </app-resumo-orcamento>
      </div>
    }

    <!-- Step 4: Gerar Proposta Oficial -->
    @if (currentStep === 4) {
      <div class="step-content">
        @if (!propostaGerada) {
          <ion-card>
            <ion-card-header>
              <ion-card-title>Dados de Contato</ion-card-title>
              <ion-card-subtitle>Informe seu melhor e-mail e WhatsApp para envio da proposta formal</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content [formGroup]="formulario">
              <ion-item>
                <ion-label position="stacked">
                  E-mail <ion-text color="danger">*</ion-text>
                </ion-label>
                <ion-input
                  type="email"
                  formControlName="email"
                  placeholder="seu@email.com"
                  required>
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">
                  WhatsApp <ion-text color="danger">*</ion-text>
                </ion-label>
                <ion-input
                  type="tel"
                  formControlName="telefone"
                  placeholder="(00) 00000-0000"
                  required>
                </ion-input>
              </ion-item>
            </ion-card-content>
          </ion-card>
        } @else {
          <ion-card>
            <ion-card-header>
              <ion-card-title>Proposta Gerada com Sucesso! üéâ</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <p>Obrigado! Voc√™ receber√° um e-mail em <strong>{{ formulario.get('email')?.value }}</strong> com a proposta do or√ßamento.</p>
              <p>Se precisar de ajuda, √© s√≥ chamar!</p>
            </ion-card-content>
          </ion-card>
        }
      </div>
    }

    <!-- Navigation Buttons - Apenas para steps principais (n√£o para sub-steps) -->
    @if (currentStep !== 2) {
      <div class="navigation-buttons">
        @if (currentStep > 1) {
          <ion-button 
            fill="outline" 
            (click)="previousStep()"
            class="nav-btn">
            <ion-icon name="arrow-back" slot="start"></ion-icon>
            Anterior
          </ion-button>
        }

        @if (currentStep === 3) {
          <ion-button 
            color="success"
            [disabled]="!canProceedToNextStep() || isLoading"
            (click)="confirmarOrcamento()"
            class="nav-btn">
            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
            Confirmar Or√ßamento
          </ion-button>
        } @else if (currentStep === 4 && !propostaGerada) {
          <ion-button 
            color="success"
            [disabled]="!canProceedToNextStep() || isLoading"
            (click)="finalizarOrcamento()"
            class="nav-btn">
            @if (isLoading) {
              <ion-spinner name="crescent" color="light"></ion-spinner>
              <span class="ml-2">Gerando...</span>
            } @else {
              <ion-icon name="document-text" slot="start"></ion-icon>
              Gerar Proposta Oficial
            }
          </ion-button>
        } @else if (currentStep === 4 && propostaGerada) {
          <ion-button 
            color="success"
            (click)="verPropostaCompleta()"
            class="nav-btn">
            <ion-icon name="document-text" slot="start"></ion-icon>
            Ver Proposta Completa
          </ion-button>
          <ion-button 
            fill="outline"
            (click)="novoOrcamento()"
            class="nav-btn">
            <ion-icon name="refresh" slot="start"></ion-icon>
            Novo Or√ßamento
          </ion-button>
        } @else if (currentStep < totalSteps) {
          <ion-button 
            [disabled]="!canProceedToNextStep() || isLoading"
            (click)="nextStep()"
            class="nav-btn">
            Pr√≥ximo
            <ion-icon name="arrow-forward" slot="end"></ion-icon>
          </ion-button>
        }
      </div>
    }

  </form>
</ion-content>

